from pathlib import Path
import cv2
import csv
import numpy as np

def run_inference_with_optional_gt(
    model,
    input_images_path,
    output_dir,
    csv_path,
    confidence_threshold=0.25,
    iou_threshold=0.7,
    gt_labels_dir=None,
):
    """
    Run YOLO inference on a directory of images.
    Optionally overlay GT labels (YOLO format) if gt_labels_dir is provided.
    """

    input_images_path = Path(input_images_path)
    output_dir = Path(output_dir)
    csv_path = Path(csv_path)

    output_dir.mkdir(parents=True, exist_ok=True)

    if not csv_path.exists():
        with open(csv_path, mode="w", newline="") as f:
            writer = csv.writer(f)
            writer.writerow(["image_name", "class", "confidence"])

    list_images_path = list(input_images_path.glob("*.jpg"))

    with open(csv_path, mode="a", newline="") as f:
        writer = csv.writer(f)

        for img_path in list_images_path:
            img = cv2.imread(str(img_path))
            if img is None:
                continue

            h, w = img.shape[:2]

            results = model.predict(
                source=img,
                conf=confidence_threshold,
                iou=iou_threshold,
                save=False,
                verbose=False,
            )

            result = results[0]
            annotated = result.plot()

            if gt_labels_dir is not None:
                label_path = Path(gt_labels_dir) / f"{img_path.stem}.txt"

                if label_path.exists():
                    with open(label_path, "r") as lf:
                        for line in lf:
                            cls, xc, yc, bw, bh = map(float, line.split())

                            # YOLO -> pixel coords
                            x1 = int((xc - bw / 2) * w)
                            y1 = int((yc - bh / 2) * h)
                            x2 = int((xc + bw / 2) * w)
                            y2 = int((yc + bh / 2) * h)

                            # Draw GT box (green)
                            cv2.rectangle(
                                annotated,
                                (x1, y1),
                                (x2, y2),
                                (0, 255, 0),
                                2,
                            )
                            cv2.putText(
                                annotated,
                                f"GT:{model.names[int(cls)]}",
                                (x1, max(y1 - 5, 15)),
                                cv2.FONT_HERSHEY_SIMPLEX,
                                0.5,
                                (0, 255, 0),
                                1,
                            )

            output_path = output_dir / img_path.name
            cv2.imwrite(str(output_path), annotated)

            if result.boxes is not None:
                for box in result.boxes:
                    cls_id = int(box.cls.item())
                    cls_name = model.names[cls_id]
                    conf = float(box.conf.item())

                    writer.writerow(
                        [img_path.name, cls_name, round(conf, 4)]
                    )